@using VGWagers.Resource
@using VGWagers.Models
@model GameViewModel


  
<div class="col-md-12">
    @{
        Html.EnableUnobtrusiveJavaScript();
        Html.EnableClientValidation();
    }
    @using (Html.BeginForm("EditGame", "Lookup", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "form-horizontal", role = "form", id = "gamedetailform" }))
    {
        @Html.AntiForgeryToken()

        if (@ViewBag.Mode == "Edit")
        {
            <h4 class="lookup-list-title">Edit Game record</h4>
        }
        if (@ViewBag.Mode == "New")
        {
            <h4 class="lookup-list-title">Add a new Game</h4>
        }
        <hr />
        <div class="alert alert-danger" role="alert" style="display: none" id="alertBox"></div>
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.Hidden("hdnPageMode", (Object)ViewBag.Mode)
        <div class="col-md-8">

            <div class="form-group">
                @Html.LabelFor(m => m.GAMENAME, new { @class = "col-md-2 control-label" })
                <div class="col-md-4">
                    @Html.TextBoxFor(m => m.GAMENAME, new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.GAMENAME, "", new { @class = "text-danger" })
                </div>

                @Html.LabelFor(m => m.GENRE, new { @class = "col-md-2 control-label" })
                <div class="col-md-4">
                    @Html.DropDownList("GENREID", null, String.Empty, new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.GENREID, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="form-group">
                @Html.LabelFor(m => m.ISACTIVE, new { @class = "col-md-2 control-label" })
                <div class="col-md-4 form-control-static">
                    @Html.CheckBoxFor(m => m.ISACTIVE, new { @class = "checkbox" } )
                </div>

                @Html.LabelFor(m => m.RELEASEDATE, new { @class = "col-md-2 control-label" })
                <div class="col-md-4 form-control-static">
                    @Html.TextBoxFor(m => m.RELEASEDATE, new { @class = "form-control datepicker", type = "date" })
                    @Html.ValidationMessageFor(m => m.RELEASEDATE, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="form-group margin-bottom-5">
                @Html.LabelFor(m => m.AVAILABLEONPLATFORMS, new { @class = "col-md-2 control-label" })
                <div class="col-md-4 form-control-static">
                    @Html.TextBox("txtPlatform", "",
                                        new
                                        {
                                            @class = "autocomplete-with-hidden form-control",
                                            data_url = Url.Action("GetActivePlatforms", "Lookup"),
                                            autocomplete = "on"
                                        })
                    @Html.Hidden("hdnSelectedPlatform")
                    @Html.ListBoxFor(m => m.AVAILABLEONPLATFORMS, new MultiSelectList(Model.AVAILABLEONPLATFORMS), new { id = "lstPlatforms", @class = "form-control platformList", Multiple = "multiple", Size = 5, style = "width: 100%;display:none;" })
                    <ul id="ulPlatforms" class="list-inline"></ul>
                </div>
                
                @Html.LabelFor(m => m.DIIFICULTYLEVELS, new { @class = "col-md-2 control-label" })
                <div class="col-md-4 form-control-static">
                    @*@Html.DropDownList("DIFFICULTYLEVELID", String.Empty)*@
                    @Html.TextBox("txtDifficultyLevel", "",
                                    new
                                    {
                                        @class = "autocomplete-with-hidden form-control",
                                        data_url = Url.Action("GetActiveDifficultyLevels", "Lookup"),
                                        autocomplete = "on"
                                    })
                    @Html.Hidden("hdnSelectedDifficultyLevel")
                    @Html.ListBoxFor(m => m.DIIFICULTYLEVELS, new MultiSelectList(Model.DIIFICULTYLEVELS), new { id = "lstDifficultyLevels", @class = "form-control", Multiple = "multiple", Size = 5, style = "width: 100%;display:none;" })
                    <ul id="ulDifficultyLevels" class="list-inline"></ul>
                </div>
            </div>
            <div class="form-group" id="removeItems" style="display:none;">
                <div class="col-md-4 col-md-offset-2 form-control-static no-top-padding">
                    @{
                        if (@ViewBag.Mode == "Edit")
                        {
                            <div id="removePlatformsEdit" style="display:none;">
                                @Ajax.ActionLink(" Remove selected Platforms(s)", "RemoveGamePlatform", new { GameId = Model.GAMEID },
                                                                        new AjaxOptions()
                                                                        {
                                                                            HttpMethod = "Delete",
                                                                            UpdateTargetId = "divMainContent",
                                                                            Confirm = "Are you sure you want to remove the selected console(s) / platform(s) for this game?",
                                                                            OnComplete = "function() { window.location.href = window.location.href; $('#main-loading-div-background').hide();}"
                                                                        },
                                                                        new { @class = "remove glyphicon glyphicon-remove link-cursor" }
                                                        )
                            </div>
                        }
                        else if (@ViewBag.Mode == "New")
                        {
                            @*<div id="removePlatformsNew" style="display:none;">
                                <a class="remove glyphicon glyphicon-remove link-cursor" onclick="removeSelectedItems('lstPlatforms');"> </a>
                                <a class="remove link-cursor" onclick="removeSelectedItems('lstPlatforms');"> Click here to remove selected Platforms(s)</a>
                            </div>*@
                        }
                    }
                </div>

                <div class="col-md-4 col-md-offset-2 form-control-static no-top-padding">
                    @{
                        if (@ViewBag.Mode == "Edit")
                        {
                            <div id="removeDifficultyLevelsEdit" style="display:none;">
                                @Ajax.ActionLink(" Remove selected Difficulty Level(s)", "RemoveGameDifficultyLevel", new { GameId = Model.GAMEID },
                                                                        new AjaxOptions()
                                                                        {
                                                                            HttpMethod = "Delete",
                                                                            UpdateTargetId = "divMainContent",
                                                                            Confirm = "Are you sure you want to remove the selected Difficulty Level(s) for this game?",
                                                                            OnComplete = "function() { window.location.href = window.location.href; $('#main-loading-div-background').hide();}"
                                                                        },
                                                                  new { @class = "glyphicon glyphicon-remove link-cursor" }
                                                                )
                            </div>
                        }
                        else if (ViewBag.mode == "New")
                        {
                            @*<div id="removeDifficultyLevelsNew" style="display:none;">
                                <a class="glyphicon glyphicon-remove link-cursor" onclick="removeSelectedItems('lstDifficultyLevels');"> </a>
                                <a class="link-cursor" onclick="removeSelectedItems('lstDifficultyLevels');"> Click here to remove selected Difficulty Level(s)</a>
                            </div>*@
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-3">

        </div>

        <div class="form-group">
            <div class="col-md-offset-7 col-md-1">
                <input type="submit" class="btn btn-primary btn-lg" value="Save" />
            </div>
            <div class="col-md-4 lookup-list-title">
                @Html.ActionLink(" Cancel and go back to Games List", "Index", "Lookup", routeValues: null, htmlAttributes: new { id = "cancelGameLink", @class = "modal-link cancel-link" })
            </div>
        </div>
        }
    </div>

<nav class="context-menu">
    <ul class="context-menu__items">
        <li class="context-menu__item">
            <a href="#" class="context-menu__link">
                <i class="fa fa-eye"></i> Remove
            </a>
        </li>
    </ul>
</nav>

    
<script>
    $(function () {
        if ($('#hdnPageMode').val() == 'Edit')
        {
            if ($('#lstPlatforms').length() > 0)
            {
                $('#removeItems').show();
                $('#removePlatformsEdit').show();
            }
            
            if ($('#lstDifficultyLevels').length() > 0) {
                $('#removeItems').show();
                $('#removeDifficultyLevelsEdit').show();
            }
        }

        $('#txtPlatform').autocomplete({
            minLength: 1,
            source: function (request, response) {
                var url = $(this.element).data('url');

                $.getJSON(url, { searchText: request.term }, function (data) {
                    response($.map(data,
                        function (item) {
                            return {
                                label: item.PLATFORMNAME,
                                value1: item.PLATFORMID
                            }
                        }));
                })
            },
            select: function (event, ui) {
                $(event.target).next('input[type=hidden]').val(ui.item.value1);
                //$(event.target).val(ui.item.label);

                var optionVal = ui.item.value1;
                var exists = false;
                $('#lstPlatforms option').each(function () {
                    $(this).removeAttr("selected");

                    if (this.value == optionVal) {
                        exists = true;
                    }
                });

                if (!exists) {
                    $('#lstPlatforms').append('<option value="' + ui.item.value1 + '" selected data-icon="glyphicon-remove">' +
                        ui.item.label +
                        "</option>"
                        );
                    $('#ulPlatforms').append('<li style="margin:2px;" value=' + ui.item.value1 +
                                             '><span style="" class="badge platform-badge">' +
                                             ui.item.label + '</span></li>');

                    $('#ulPlatforms > li[value=' +
                            ui.item.value1 +
                            '] > span').append("<a style='' > | <span  onclick='removeItem(\"ulPlatforms\", \"lstPlatforms\", " +
                                                ui.item.value1 +
                                               ");'" + ' style="vertical-align:baseline;font-size:small;cursor:pointer;" class="remove glyphicon glyphicon-remove"></span></a>'
                                              );

                    $(event.target).val('');
                    //$('#removeItems').show();
                    //$('#removePlatformsEdit').show();
                    //$('#removePlatformsNew').show();
                    return false;
                }
                else {
                    $(event.target).val(ui.item.label + ' - already added!');
                    return false;
                }
                
            },
            change: function (event, ui) {
               if (!ui.item) {
                    $(event.target).val('').next('input[type=hidden]').val('');
                }
            }
        });

        $('#txtPlatform').click(
            function () {
                $('#txtPlatform').val('');
            }
        );

        $('#txtDifficultyLevel').autocomplete({
            minLength: 1,
            source: function (request, response) {
                var url = $(this.element).data('url');

                $.getJSON(url, { searchText: request.term }, function (data) {
                    response($.map(data,
                        function (item) {
                            return {
                                label: item.DIFFICULTYLEVELNAME,
                                value1: item.DIFFICULTYLEVELID
                            }
                        }));
                })
            },
            select: function (event, ui) {
                $(event.target).next('input[type=hidden]').val(ui.item.value1);
                //$(event.target).val(ui.item.label);

                var optionVal = ui.item.value1;
                var exists = false;
                $('#lstDifficultyLevels option').each(function () {
                    $(this).removeAttr("selected");

                    if (this.value == optionVal) {
                        exists = true;
                    }
                });

                if (!exists) {
                    $('#lstDifficultyLevels').append('<option value="' + ui.item.value1 + '" selected data-icon="glyphicon-remove">' +
                        ui.item.label +
                        "</option>"
                        );
                    $('#ulDifficultyLevels').append('<li style="margin:2px;" value=' + ui.item.value1 +
                                             '><span style="" class="badge platform-badge">' +
                                             ui.item.label + '</span></li>');

                    $('#ulDifficultyLevels > li[value=' +
                            ui.item.value1 +
                            '] > span').append("<a style='' > | <span  onclick='removeItem(\"ulDifficultyLevels\", \"lstDifficultyLevels\", " +
                                                ui.item.value1 +
                                               ");'" + ' style="vertical-align:baseline;font-size:small;cursor:pointer;" class="remove glyphicon glyphicon-remove"></span></a>'
                                              );
                    $(event.target).val('');
                    //$('#removeItems').show();
                    //$('#removeDifficultyLevelsEdit').show();
                    //$('#removeDifficultyLevelsNew').show();
                    return false;
                }
                else {
                    $(event.target).val(ui.item.label + ' - already added!');
                    return false;
                }
                
            },
            change: function (event, ui) {
                if (!ui.item) {
                    $(event.target).val('').next('input[type=hidden]').val('');
                }
            }
        });

        $('#txtDifficultyLevel').click(
            function () {
                $('#txtDifficultyLevel').val('');
            }
        );

    })

    function removeSelectedItems(listBoxControl) {
        var action_list = document.getElementById(listBoxControl);

        // Remember selected items.
        var is_selected = [];
        for (var i = 0; i < action_list.options.length; ++i) {
            is_selected[i] = action_list.options[i].selected;
        }

        // Remove selected items.
        i = action_list.options.length;
        while (i--) {
            if (is_selected[i]) {
                action_list.remove(i);
            }
        }
    }

    function removeItem(ulControl, listBoxControl, value) {
        $('#' + ulControl + " > li[value=" + value + "]").remove();
        $('#' + listBoxControl + " option[value=" + value + "]").remove();
        
    }
</script>